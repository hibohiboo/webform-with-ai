# Feature Specification: CSV ダウンロード日付範囲フィルタ

**Feature Branch**: `001-csv-date-filter`
**Created**: 2026-01-30
**Status**: Draft
**Input**: User description: "CSV ダウンロード API に日付範囲による絞り込みを追加したい。クエリパラメータ from と to を追加。フォーマットは YYYY-MM-DD。from はその日の 00:00:00 から、to はその日の 23:59:59.999 までを含める。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 特定期間のフィードバックを抽出する (Priority: P1)

管理者として、特定の期間（例: 月次）に収集されたフィードバックのみを CSV でダウンロードしたい。レポート作成や分析のために、必要な期間のデータだけを効率的に取得できる。

**Why this priority**: 日付範囲フィルタの中核機能であり、この機能がなければ管理者は全データをダウンロードして手動でフィルタリングする必要がある。業務効率に直結する最重要機能。

**Independent Test**: from と to パラメータを指定して CSV をダウンロードし、含まれるレコードがすべて指定期間内であることを確認する。

**Acceptance Scenarios**:

1. **Given** フィードバックデータが複数日にわたって存在する, **When** from=2026-01-01&to=2026-01-31 でダウンロード, **Then** 2026年1月のフィードバックのみが CSV に含まれる
2. **Given** フィードバックが 2026-01-15 23:59:59.999 に登録されている, **When** to=2026-01-15 でダウンロード, **Then** そのフィードバックが CSV に含まれる（境界値テスト）
3. **Given** フィードバックが 2026-01-15 00:00:00.000 に登録されている, **When** from=2026-01-15 でダウンロード, **Then** そのフィードバックが CSV に含まれる（境界値テスト）

---

### User Story 2 - 開始日のみ指定して以降のデータを取得する (Priority: P2)

管理者として、特定日以降のすべてのフィードバックをダウンロードしたい。例えば、前回のレポート以降に新しく追加されたデータのみを取得する場合に使用する。

**Why this priority**: 部分的なフィルタリングのユースケースとして重要。from のみ指定、to のみ指定のどちらにも対応することで、柔軟な期間指定が可能になる。

**Independent Test**: from パラメータのみを指定して CSV をダウンロードし、その日以降のすべてのレコードが含まれることを確認する。

**Acceptance Scenarios**:

1. **Given** フィードバックデータが 2026-01-01 から 2026-01-31 まで存在する, **When** from=2026-01-15 のみ指定してダウンロード, **Then** 2026-01-15 以降のフィードバックのみが CSV に含まれる
2. **Given** フィードバックデータが 2026-01-01 から 2026-01-31 まで存在する, **When** to=2026-01-15 のみ指定してダウンロード, **Then** 2026-01-15 以前のフィードバックのみが CSV に含まれる

---

### User Story 3 - 従来通り全件ダウンロードする (Priority: P3)

管理者として、パラメータ未指定の場合は従来通り全フィードバックをダウンロードしたい。既存の運用に影響を与えず、後方互換性を維持する。

**Why this priority**: 後方互換性の維持は重要だが、既存機能の動作確認のため優先度は他より低い。

**Independent Test**: パラメータなしで CSV をダウンロードし、全レコードが含まれることを確認する。

**Acceptance Scenarios**:

1. **Given** フィードバックデータが存在する, **When** パラメータなしでダウンロード, **Then** 全フィードバックが CSV に含まれる（従来動作）

---

### Edge Cases

- from が to より後の日付の場合: 空の結果を返す（エラーではなく、条件に合致するデータがない状態として扱う）
- 存在しないデータ範囲を指定した場合: 204 No Content を返す（既存動作と同様）
- 不正な日付フォーマット（例: 2026/01/01, 01-01-2026）の場合: 400 Bad Request を返す
- 無効な日付（例: 2026-02-30）の場合: 400 Bad Request を返す

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは CSV ダウンロード API でクエリパラメータ `from` を受け付け、指定日の 00:00:00.000 UTC 以降のデータをフィルタする
- **FR-002**: システムは CSV ダウンロード API でクエリパラメータ `to` を受け付け、指定日の 23:59:59.999 UTC までのデータをフィルタする
- **FR-003**: `from` と `to` の日付フォーマットは `YYYY-MM-DD` 形式のみを受け付ける
- **FR-004**: `from` のみ指定された場合、その日以降の全データを返す
- **FR-005**: `to` のみ指定された場合、その日以前の全データを返す
- **FR-006**: 両パラメータが未指定の場合、従来通り全データを返す
- **FR-007**: 不正な日付フォーマットまたは無効な日付が指定された場合、400 Bad Request を返す
- **FR-008**: フィルタ結果が空の場合、204 No Content を返す（既存動作を維持）

### Key Entities

- **DateRange**: 日付範囲を表現するパラメータペア（from, to）。各日付は YYYY-MM-DD 形式の文字列として受け取り、内部で時刻範囲に変換される
- **FeedbackResponse**: 既存のフィードバック回答エンティティ。`submittedAt` フィールド（ISO 8601 UTC 形式）がフィルタ対象

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者は日付範囲を指定して、必要な期間のフィードバックのみをダウンロードできる
- **SC-002**: 境界値（指定日の開始時刻・終了時刻）のデータが正しく含まれる/除外される
- **SC-003**: パラメータ未指定時は全件ダウンロードできる（後方互換性維持）
- **SC-004**: 不正な入力に対して適切なエラーメッセージが返される

## Assumptions

- タイムゾーンは UTC を基準とする（既存の `submittedAt` が ISO 8601 UTC 形式で保存されているため）
- 日付パラメータのバリデーションはサーバーサイドで行う
- 大量データのパフォーマンスについては、既存の全件取得と同等のパフォーマンスを維持する（フィルタリングは取得後に行う）
